<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Skillora - AI Tutors">
    <meta name="theme-color" content="#6200ea">
    <title>Skillora - AI Tutors</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern.css') }}">
    
    <!-- Add markdown-it for proper formatting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/12.3.2/markdown-it.min.js"></script>
    
    <!-- Custom Chat CSS -->
    <style>
        /* Base styles */
        :root {
            --chat-font-size: 0.85rem;
        }
        
        /* Theme variables - Light (default) */
        :root {
            --chat-bg-color: var(--background-light);
            --chat-message-bg: var(--background-white);
            --chat-text-color: var(--text-primary);
            --chat-secondary-text: var(--text-secondary);
            --chat-input-bg: rgba(98, 0, 234, 0.05);
            --chat-user-message-bg: var(--primary);
            --chat-user-text-color: white;
        }
        
        /* Dark theme */
        .dark-theme {
            --chat-bg-color: #1a1a2e;
            --chat-message-bg: #252541;
            --chat-text-color: #e6e6e6;
            --chat-secondary-text: #b8b8b8;
            --chat-input-bg: rgba(255, 255, 255, 0.08);
            --chat-user-message-bg: #6a26cd;
            --chat-user-text-color: white;
        }
        
        /* Font sizes */
        .font-small {
            --chat-font-size: 0.75rem;
        }
        
        .font-medium {
            --chat-font-size: 0.85rem;
        }
        
        .font-large {
            --chat-font-size: 0.95rem;
        }
        
        /* Apply theme variables to elements */
        .chat-container {
            display: flex;
            flex-direction: column;
            min-height: 500px; /* Ensure minimum height for visibility */
            height: calc(100vh - 170px);
            background-color: var(--chat-bg-color);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            position: relative;
        }
        
        .chat-header {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: var(--chat-message-bg);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: white;
            font-size: 1.5rem;
        }
        
        .chat-info {
            flex: 1;
        }
        
        .chat-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.2rem;
        }
        
        .chat-status {
            font-size: 0.8rem;
            color: var(--success);
            display: flex;
            align-items: center;
        }
        
        .chat-status i {
            margin-right: 0.3rem;
            font-size: 0.7rem;
        }
        
        .chat-actions {
            display: flex;
        }
        
        .chat-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: rgba(98, 0, 234, 0.05);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chat-action-btn:hover {
            background-color: rgba(98, 0, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: var(--chat-bg-color, #f5f7fa);
            min-height: 300px; /* Add minimum height to ensure visibility */
            width: 100%;
            position: relative;
            z-index: 1;
        }
        
        /* Make sure no debug elements are shown */
        .chat-messages:before, .chat-messages:after {
            display: none !important;
        }
        
        .message {
            display: flex;
            margin-bottom: 1.5rem;
            max-width: 85%;
        }
        
        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            margin: 0 0.9rem;
            aspect-ratio: 1;
        }
        
        .message.user .message-avatar {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
        }
        
        .message-content {
            padding: 1rem 1.2rem;
            border-radius: 18px;
            background-color: var(--chat-message-bg);
            box-shadow: var(--shadow-sm);
            position: relative;
            color: var(--chat-text-color);
        }
        
        .message.user .message-content {
            background-color: var(--chat-user-message-bg);
            color: var(--chat-user-text-color);
        }
        
        .message-text {
            line-height: 1.5;
            font-size: var(--chat-font-size);
            position: relative;
        }
        
        .message-text span {
            display: inline;
        }
        
        .message-text p {
            margin-bottom: 0.8rem;
        }
        
        .message-text p:last-child {
            margin-bottom: 0;
        }
        
        .message-text ul, .message-text ol {
            margin-left: 1.5rem;
            margin-bottom: 0.8rem;
        }
        
        .message-text li {
            margin-bottom: 0.3rem;
        }
        
        .message-text h1, .message-text h2, .message-text h3,
        .message-text h4, .message-text h5, .message-text h6 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .message-text code {
            background-color: rgba(0,0,0,0.05);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .message-text pre {
            background-color: rgba(0,0,0,0.05);
            padding: 0.8rem;
            border-radius: 5px;
            overflow-x: auto;
            margin-bottom: 1rem;
        }
        
        .message-text pre code {
            background-color: transparent;
            padding: 0;
        }
        
        .message-text blockquote {
            border-left: 3px solid var(--primary);
            padding-left: 1rem;
            color: var(--text-secondary);
            font-style: italic;
            margin: 0.8rem 0;
        }
        
        .message.user .message-text blockquote {
            border-left-color: rgba(255, 255, 255, 0.5);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .message-time {
            font-size: calc(var(--chat-font-size) * 0.85);
            color: var(--chat-secondary-text);
            margin-top: 0.4rem;
            text-align: right;
        }
        
        .message.user .message-time {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .message-typing {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 18px;
            background-color: var(--background-white);
            box-shadow: var(--shadow-sm);
            max-width: 100px;
            margin-left: 52px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            margin: 0 3px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingAnimation {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        
        .chat-input-container {
            padding: 1rem 1.5rem;
            background-color: var(--background-white);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .chat-input {
            flex: 1;
            border: none;
            background-color: var(--chat-input-bg);
            border-radius: 24px;
            padding: 0.8rem 1.2rem;
            font-size: var(--chat-font-size);
            color: var(--chat-text-color);
            transition: all 0.2s ease;
            outline: none;
        }
        
        .chat-input:focus {
            box-shadow: 0 0 0 2px rgba(98, 0, 234, 0.2);
        }
        
        .chat-input-actions {
            display: flex;
            margin-left: 1rem;
            align-items: center;
        }
        
        .chat-input-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chat-input-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(98, 0, 234, 0.3);
        }
        
        .chat-input-btn.mic {
            background-color: rgba(98, 0, 234, 0.1);
            color: var(--primary);
        }
        
        .chat-input-btn.mic:hover {
            background-color: rgba(98, 0, 234, 0.2);
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .suggestion-chip {
            background-color: rgba(98, 0, 234, 0.05);
            border: 1px solid rgba(98, 0, 234, 0.1);
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .suggestion-chip:hover {
            background-color: rgba(98, 0, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .ai-features {
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .ai-feature-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }
        
        .model-info {
            background-color: rgba(98, 0, 234, 0.03);
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        
        .model-info i {
            margin-right: 8px;
            color: var(--primary);
        }
        
        /* Modal styles for settings and info */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            background-color: var(--chat-message-bg);
            margin: 5% auto;
            padding: 25px;
            width: 90%;
            max-width: 650px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            animation: modalFadeIn 0.3s;
            color: var(--chat-text-color);
        }
        
        @keyframes modalFadeIn {
            from {opacity: 0; transform: translateY(-30px);}
            to {opacity: 1; transform: translateY(0);}
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
            display: flex;
            align-items: center;
        }
        
        .modal-title i {
            margin-right: 10px;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .modal-close {
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        /* Improved settings modal styles */
        .setting-group {
            margin-bottom: 28px;
            background-color: rgba(98, 0, 234, 0.03);
            padding: 15px;
            border-radius: 12px;
            border-left: 3px solid var(--primary);
        }
        
        .setting-label {
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
            color: var(--primary);
            font-size: 0.9rem;
        }
        
        .setting-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .setting-option {
            flex: 1;
            min-width: 80px;
        }
        
        /* Custom radio buttons */
        .custom-radio {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--background-white);
            border: 2px solid rgba(98, 0, 234, 0.1);
            border-radius: 10px;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .custom-radio:hover {
            border-color: rgba(98, 0, 234, 0.3);
            transform: translateY(-2px);
        }
        
        .custom-radio input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }
        
        .custom-radio input:checked + .radio-content {
            color: var(--primary);
        }
        
        .custom-radio input:checked ~ .radio-check {
            background-color: var(--primary);
        }
        
        .custom-radio input:checked ~ .radio-icon {
            color: var(--primary);
            transform: scale(1.1);
        }
        
        .radio-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        
        .radio-content {
            font-weight: 500;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .radio-check {
            width: 40px;
            height: 4px;
            background-color: rgba(98, 0, 234, 0.1);
            border-radius: 2px;
            margin-top: 8px;
            transition: all 0.2s ease;
        }
        
        .radio-sample {
            margin-top: 5px;
            opacity: 0.7;
            font-size: 0.8rem;
        }
        
        /* Sample text for font sizes */
        .sample-small {
            font-size: 0.75rem;
        }
        
        .sample-medium {
            font-size: 0.85rem;
        }
        
        .sample-large {
            font-size: 0.95rem;
        }
        
        /* Response style indicators */
        .style-indicator {
            font-size: 0.7rem;
            text-align: center;
            opacity: 0.7;
            margin-top: 5px;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Save button */
        .settings-save-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 20px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(98, 0, 234, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(98, 0, 234, 0.25);
        }
        
        .settings-save-btn i {
            margin-right: 8px;
        }
        
        .fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            border-radius: 0 !important;
            margin: 0 !important;
        }
        
        /* Viewport height fixes */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        
        .dashboard-container {
            height: 100vh;
            overflow: hidden;
            display: flex;
        }
        
        .main-content {
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
            padding-bottom: 10px;
        }
        
        .welcome-text {
            flex: 1;
            min-width: 250px;
        }
        
        .welcome-text h1 {
            margin-bottom: 0.2rem;
        }
        
        .welcome-text p {
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: auto;
            max-height: calc(100vh - 130px);
            background-color: var(--chat-bg-color);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        
        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        /* Responsive fixes for buttons */
        @media (max-width: 768px) {
            .dashboard-header {
                padding: 1rem;
            }
            
            .welcome-text h1 {
                font-size: 1.5rem;
            }
            
            .welcome-text p {
                display: none;
            }
            
            .header-actions {
                display: flex;
                flex-direction: row;
                gap: 8px;
                justify-content: flex-end;
                margin-top: 10px;
            }
            
            .setting-options {
                flex-direction: row;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 10px;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .setting-options::-webkit-scrollbar {
                display: none;
            }
            
            .setting-option {
                flex: 0 0 auto;
                width: 90px;
                min-width: 90px;
            }
            
            .modal-content {
                height: auto;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .chat-container {
                max-height: calc(100vh - 120px);
            }
            
            .message {
                max-width: 95%;
            }
            
            /* More compact welcome message */
            .message-content {
                padding: 0.8rem 1rem;
            }
            
            .message-text p {
                margin-bottom: 0.6rem;
            }
            
            .ai-features {
                margin-top: 15px;
                margin-bottom: 8px;
            }
            
            /* Make suggestion chips wrap better */
            .suggestions {
                gap: 6px;
                margin-bottom: 12px;
            }
            
            .suggestion-chip {
                padding: 6px 10px;
                font-size: 13px;
            }
            
            /* Smaller model info */
            .model-info {
                padding: 8px 10px;
                font-size: 12px;
            }
            
            /* Smaller avatar for messages */
            .message-avatar {
                width: 38px;
                height: 38px;
                font-size: 1rem;
                margin: 0 0.7rem;
                aspect-ratio: 1;
            }
            
            /* Input styling for mobile */
            .chat-input-container {
                padding: 0.8rem 1rem;
            }
            
            .chat-input {
                padding: 0.7rem 1rem;
            }
            
            .chat-input-btn {
                width: 38px;
                height: 38px;
            }
            
            /* More compact header */
            .chat-header {
                padding: 0.8rem 1rem;
            }
            
            .chat-avatar {
                width: 40px;
                height: 40px;
                font-size: 1.3rem;
            }
            
            .cursor-blink {
                height: 1em;
            }
            
            /* Make the typing animation faster on mobile */
            .message-text span {
                transition: opacity 0.08s ease-in-out !important;
            }
            
            /* Sidebar for mobile */
            .sidebar {
                position: fixed;
                width: 250px;
                transform: translateX(-100%);
                z-index: 100;
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
        }
        
        /* Always show buttons in a horizontal row */
        @media (max-width: 576px) {
            .dashboard-header {
                padding-top: 10px;
                padding-bottom: 10px;
            }
            
            .welcome-text h1 {
                font-size: 1.5rem;
                margin-bottom: 0.1rem;
            }
            
            .welcome-text p {
                font-size: 0.85rem;
            }
            
            .header-actions {
                margin-top: 8px;
                justify-content: flex-start;
            }
            
            .action-btn {
                width: 36px;
                height: 36px;
            }
        }
        
        /* Typewriter animation styles */
        @keyframes blinkCursor {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .typing-animation span {
            display: inline;
        }

        .cursor-blink {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: var(--primary);
            margin-left: 2px;
            vertical-align: middle;
            animation: blinkCursor 0.8s infinite;
        }

        .chat-input-btn.upload-btn {
            display: none;
        }

        .chat-input-btn.upload-btn:hover {
            display: none;
        }

        .image-preview {
            display: none;
        }

        .preview-container {
            display: none;
        }

        .remove-image {
            display: none;
        }

        .message-image-container {
            display: none;
        }

        .message-image {
            display: none;
        }

        .image-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .image-fullscreen img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .image-fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        /* Chat history styling */
        .chat-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            background-color: rgba(98, 0, 234, 0.03);
            margin-bottom: 15px;
            transition: all 0.2s ease;
            cursor: pointer;
            border-left: 3px solid var(--primary);
        }
        
        .chat-history-item:hover {
            background-color: rgba(98, 0, 234, 0.08);
            transform: translateY(-2px);
        }
        
        .chat-history-details {
            flex: 1;
        }
        
        .chat-history-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .chat-history-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .chat-history-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 400px;
        }
        
        .chat-history-actions {
            display: flex;
            gap: 10px;
        }
        
        .chat-history-action {
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
        }
        
        .chat-history-action:hover {
            color: var(--primary);
            background-color: rgba(98, 0, 234, 0.1);
        }
        
        .chat-history-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .chat-history-empty i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Menu Overlay -->
    <div class="menu-overlay"></div>

    <!-- Chat Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-sliders-h"></i>
                    Chat Settings
                </div>
                <span class="modal-close" id="close-settings">&times;</span>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label class="setting-label">Font Size</label>
                    <div class="setting-options">
                        <div class="setting-option">
                            <label class="custom-radio">
                                <input type="radio" id="font-small" name="font-size" value="small">
                                <div class="radio-icon">
                                    <i class="fas fa-font" style="font-size: 1.2rem;"></i>
                                </div>
                                <div class="radio-content">Small</div>
                                <div class="radio-sample sample-small">Aa</div>
                                <div class="radio-check"></div>
                            </label>
                        </div>
                        <div class="setting-option">
                            <label class="custom-radio">
                                <input type="radio" id="font-medium" name="font-size" value="medium" checked>
                                <div class="radio-icon">
                                    <i class="fas fa-font"></i>
                                </div>
                                <div class="radio-content">Medium</div>
                                <div class="radio-sample sample-medium">Aa</div>
                                <div class="radio-check"></div>
                            </label>
                        </div>
                        <div class="setting-option">
                            <label class="custom-radio">
                                <input type="radio" id="font-large" name="font-size" value="large">
                                <div class="radio-icon">
                                    <i class="fas fa-font" style="font-size: 1.8rem;"></i>
                                </div>
                                <div class="radio-content">Large</div>
                                <div class="radio-sample sample-large">Aa</div>
                                <div class="radio-check"></div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">Response Style</label>
                    <div class="setting-options">
                        <div class="setting-option">
                            <label class="custom-radio">
                                <input type="radio" id="style-concise" name="response-style" value="concise">
                                <div class="radio-icon">
                                    <i class="fas fa-bolt"></i>
                                </div>
                                <div class="radio-content">Concise</div>
                                <div class="style-indicator">Brief, to-the-point answers</div>
                                <div class="radio-check"></div>
                            </label>
                        </div>
                        <div class="setting-option">
                            <label class="custom-radio">
                                <input type="radio" id="style-balanced" name="response-style" value="balanced" checked>
                                <div class="radio-icon">
                                    <i class="fas fa-balance-scale"></i>
                                </div>
                                <div class="radio-content">Balanced</div>
                                <div class="style-indicator">Good mix of detail and brevity</div>
                                <div class="radio-check"></div>
                            </label>
                        </div>
                        <div class="setting-option">
                            <label class="custom-radio">
                                <input type="radio" id="style-detailed" name="response-style" value="detailed">
                                <div class="radio-icon">
                                    <i class="fas fa-book-open"></i>
                                </div>
                                <div class="radio-content">Detailed</div>
                                <div class="style-indicator">Comprehensive explanations</div>
                                <div class="radio-check"></div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <button class="settings-save-btn" id="save-settings">
                    <i class="fas fa-save"></i>Save Settings
                </button>
            </div>
        </div>
    </div>
    
    <!-- Info Modal -->
    <div id="info-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-info-circle"></i>
                    About Skillora AI
                </div>
                <span class="modal-close" id="close-info">&times;</span>
            </div>
            <div class="modal-body">
                <p>Skillora AI adalah asisten pembelajaran pintar yang dirancang untuk membantu Anda dalam perjalanan belajar Anda.</p>
                
                <h3>Kemampuan</h3>
                <ul>
                    <li>Menjawab pertanyaan akademis di berbagai bidang</li>
                    <li>Menjelaskan konsep yang kompleks dengan cara yang mudah dipahami</li>
                    <li>Membantu Anda memecahkan masalah</li>
                    <li>Memberikan sumber daya dan referensi tambahan</li>
                    <li>Merekomendasikan jalur pembelajaran</li>
                </ul>
                
                <h3>Model AI</h3>
                <p>Skillora AI menggunakan model bahasa canggih dari OpenRouter untuk memberikan jawaban yang tepat dan informatif.</p>
                
                <h3>Privasi</h3>
                <p>Kami menghargai privasi Anda. Percakapan Anda dengan Skillora AI disimpan secara aman dan hanya digunakan untuk meningkatkan pengalaman pengguna.</p>
            </div>
        </div>
    </div>

    <!-- Chat History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-history"></i>
                    Chat History
                </div>
                <span class="modal-close" id="close-history">&times;</span>
            </div>
            <div class="modal-body">
                <div id="chat-history-container">
                    <div class="chat-history-empty" id="history-empty">
                        <i class="fas fa-comment-slash"></i>
                        <p>No saved conversations yet.</p>
                    </div>
                    <div class="chat-history-list" id="history-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Chat History Modal -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <a href="{{ url_for('views.dashboard') }}" class="sidebar-logo">
                <div class="logo-circle">
                    <div class="logo-letter">S</div>
                </div>
                <span class="logo-text">Skillora</span>
            </a>
            
            <div class="sidebar-menu">
                <p class="menu-category">Main</p>
                <a href="{{ url_for('views.dashboard') }}" class="menu-item">
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>
                <a href="{{ url_for('views.learning_path') }}" class="menu-item">
                    <i class="fas fa-graduation-cap"></i>
                    Learning Path
                </a>
                <a href="{{ url_for('views.my_courses') }}" class="menu-item">
                    <i class="fas fa-book"></i>
                    My Courses
                </a>
                
                <p class="menu-category">Resources</p>

                <a href="{{ url_for('views.tutors') }}" class="menu-item active">
                    <i class="fas fa-chalkboard-teacher"></i>
                    AI Tutor
                </a>
                <a href="{{ url_for('views.progress') }}" class="menu-item">
                    <i class="fas fa-chart-line"></i>
                    Progress
                </a>
                
                <p class="menu-category">Account</p>
                <a href="{{ url_for('views.profile') }}" class="menu-item">
                    <i class="fas fa-user-circle"></i>
                    Profile
                </a>
                <a href="{{ url_for('views.settings') }}" class="menu-item">
                    <i class="fas fa-cog"></i>
                    Settings
                </a>
            </div>
            
            <div class="user-profile">
                <div class="user-avatar">
                    {{ user.first_name[0] }}
                </div>
                <div class="user-info">
                    <div class="user-name">{{ user.first_name }}</div>
                    <div class="user-email">{{ user.email }}</div>
                </div>
                <a href="{{ url_for('auth.logout') }}" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
                </div>
            {% endif %}
            {% endwith %}
            
            <!-- Page Header -->
            <div class="dashboard-header">
                <div class="welcome-text">
                    <h1>Skillora AI Tutor</h1>
                    <p>Your personal AI assistant for learning support and guidance</p>
                </div>
                <div class="header-actions">
                    <button class="action-btn tooltip" id="clear-chat-btn">
                        <i class="fas fa-trash-alt"></i>
                        <span class="tooltip-text">Clear chat</span>
                    </button>
                    <button class="action-btn tooltip" id="chat-history-btn">
                        <i class="fas fa-history"></i>
                        <span class="tooltip-text">Chat history</span>
                    </button>
                    <button class="action-btn tooltip" id="settings-btn">
                        <i class="fas fa-cog"></i>
                        <span class="tooltip-text">Chat settings</span>
                    </button>
                </div>
            </div>
            
            <!-- Chat Interface -->
            <div class="chat-container" id="chat-container">
                <div class="chat-header">
                    <div class="chat-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="chat-info">
                        <div class="chat-name">Skillora AI</div>
                        <div class="chat-status">
                            <i class="fas fa-circle"></i>
                            Online
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" id="info-btn">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <!-- AI Welcome Message -->
                    <div class="message">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-text">
                                <p>👋 Halo! Saya adalah Skillora AI, asisten belajar pintar Anda. Saya dapat membantu dengan pertanyaan tentang mata pelajaran, menjelaskan konsep, membimbing Anda melalui masalah, dan memberikan sumber daya tambahan.</p>
                                
                                <div class="ai-features">
                                    <div class="ai-feature-title">Beberapa cara saya dapat membantu Anda:</div>
                                    <ul>
                                        <li>Menjelaskan konsep yang kompleks dengan cara sederhana</li>
                                        <li>Memecahkan masalah dan soal latihan</li>
                                        <li>Memberikan sumber belajar tambahan</li>
                                        <li>Menyusun rencana belajar</li>
                                        <li>Menjawab pertanyaan dari berbagai bidang pengetahuan</li>
                                    </ul>
                                </div>
                                
                                <div class="suggestions">
                                    <div class="suggestion-chip">Jelaskan konsep machine learning</div>
                                    <div class="suggestion-chip">Bagaimana cara belajar efektif?</div>
                                    <div class="suggestion-chip">Bantu saya dengan matematika</div>
                                    <div class="suggestion-chip">Berikan saran proyek coding</div>
                                </div>
                                
                                <div class="model-info">
                                    <i class="fas fa-microchip"></i> Powered by advanced AI language model
                                </div>
                            </div>
                            <div class="message-time">Hari ini, 09:30</div>
                        </div>
                    </div>
                    
                    <!-- More messages will be added dynamically -->
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Tulis pesan Anda di sini..." />
                    <div class="chat-input-actions">
                        <button class="chat-input-btn" id="send-message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/ScrollTrigger.min.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Tutors page animations initialized");
        
        // IMPORTANT FALLBACK: Ensure all content becomes visible, even if animations fail
        // Add this failsafe timer that will make everything visible after 1 second no matter what
        setTimeout(function() {
            document.querySelectorAll('.chat-container, .chat-messages, .message, .chat-header, .chat-input-container, .sidebar, .main-content, .dashboard-header, .dashboard-container, .user-profile, .suggestion-chip, .model-info, .header-actions .action-btn')
            .forEach(function(el) {
                el.style.opacity = '1';
                el.style.transform = 'none';
            });
            console.log("Failsafe visibility applied");
        }, 1000);
        
        // Simplify the animation code for better reliability
        // Immediately apply transitions to all elements
        const elements = {
            '.sidebar': 'opacity 0.6s ease-out, transform 0.6s ease-out',
            '.dashboard-container': 'opacity 0.5s ease-out',
            '.main-content': 'opacity 0.6s ease-out, transform 0.6s ease-out',
            '.dashboard-header': 'opacity 0.5s ease-out, transform 0.5s ease-out',
            '.chat-container': 'opacity 0.6s ease-out, transform 0.6s ease-out',
            '.chat-header': 'opacity 0.5s ease-out',
            '.chat-messages': 'opacity 0.5s ease-out',
            '.chat-input-container': 'opacity 0.5s ease-out, transform 0.5s ease-out',
            '.message': 'opacity 0.6s ease-out, transform 0.6s ease-out',
            '.user-profile': 'opacity 0.5s ease-out',
            '.suggestion-chip': 'opacity 0.5s ease-out, transform 0.5s ease-out',
            '.model-info': 'opacity 0.6s ease-out',
            '.header-actions .action-btn': 'opacity 0.4s ease-out, transform 0.4s ease-out'
        };
        
        // Apply all transitions immediately
        Object.entries(elements).forEach(([selector, transition]) => {
            document.querySelectorAll(selector).forEach(el => {
                el.style.transition = transition;
            });
        });
        
        // Then immediately start making elements visible in sequence
        requestAnimationFrame(() => {
            document.querySelector('.sidebar').style.opacity = '1';
            document.querySelector('.sidebar').style.transform = 'translateX(0)';
            document.querySelector('.dashboard-container').style.opacity = '1';
            
            setTimeout(() => {
                document.querySelector('.main-content').style.opacity = '1';
                document.querySelector('.main-content').style.transform = 'translateY(0)';
                document.querySelector('.dashboard-header').style.opacity = '1';
                document.querySelector('.dashboard-header').style.transform = 'translateY(0)';
                
                // Header actions
                document.querySelectorAll('.header-actions .action-btn').forEach(btn => {
                    btn.style.opacity = '1';
                    btn.style.transform = 'translateY(0)';
                });
                
                // Chat container and user profile
                document.querySelector('.chat-container').style.opacity = '1';
                document.querySelector('.chat-container').style.transform = 'translateY(0)';
                document.querySelector('.user-profile').style.opacity = '1';
                
                setTimeout(() => {
                    // Chat components
                    document.querySelector('.chat-header').style.opacity = '1';
                    document.querySelector('.chat-messages').style.opacity = '1';
                    document.querySelector('.chat-input-container').style.opacity = '1';
                    document.querySelector('.chat-input-container').style.transform = 'translateY(0)';
                    
                    // Chat content
                    document.querySelectorAll('.message').forEach(msg => {
                        msg.style.opacity = '1';
                        msg.style.transform = 'translateY(0)';
                    });
                    
                    document.querySelectorAll('.suggestion-chip').forEach(chip => {
                        chip.style.opacity = '1';
                        chip.style.transform = 'translateY(0)';
                    });
                    
                    document.querySelector('.model-info').style.opacity = '1';
                }, 200);
            }, 200);
        });
        
        // Initialize markdown-it
        const md = window.markdownit({
            html: false,
            linkify: true,
            typographer: true
        });
        
        // Mobile menu toggle
        const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        const menuOverlay = document.querySelector('.menu-overlay');
        
        mobileMenuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            menuOverlay.classList.toggle('active');
        });
        
        menuOverlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            menuOverlay.classList.remove('active');
        });
        
        // Modal functionality
        const settingsModal = document.getElementById('settings-modal');
        const infoModal = document.getElementById('info-modal');
        const historyModal = document.getElementById('history-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const infoBtn = document.getElementById('info-btn');
        const chatHistoryBtn = document.getElementById('chat-history-btn');
        const closeSettings = document.getElementById('close-settings');
        const closeInfo = document.getElementById('close-info');
        const closeHistory = document.getElementById('close-history');
        const saveSettings = document.getElementById('save-settings');
        
        // Settings button
        settingsBtn.addEventListener('click', function() {
            settingsModal.style.display = 'block';
        });
        
        // Info button
        infoBtn.addEventListener('click', function() {
            infoModal.style.display = 'block';
        });

        // Chat History button
        chatHistoryBtn.addEventListener('click', function() {
            loadChatHistoryList();
            historyModal.style.display = 'block';
        });
        
        // Close buttons
        closeSettings.addEventListener('click', function() {
            settingsModal.style.display = 'none';
        });
        
        closeInfo.addEventListener('click', function() {
            infoModal.style.display = 'none';
        });

        // Close history modal
        closeHistory.addEventListener('click', function() {
            historyModal.style.display = 'none';
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
            if (event.target === infoModal) {
                infoModal.style.display = 'none';
            }
            if (event.target === historyModal) {
                historyModal.style.display = 'none';
            }
        });
        
        // Save settings
        saveSettings.addEventListener('click', function() {
            // Get selected settings
            const fontSize = document.querySelector('input[name="font-size"]:checked').value;
            const responseStyle = document.querySelector('input[name="response-style"]:checked').value;
            
            // Apply font size setting
            const mainContent = document.querySelector('.main-content');
            mainContent.classList.remove('font-small', 'font-medium', 'font-large');
            mainContent.classList.add(`font-${fontSize}`);
            
            // Store response style preference (would be used when sending requests)
            localStorage.setItem('response_style', responseStyle);
            
            // Save all settings to localStorage for persistence
            localStorage.setItem('chat_font_size', fontSize);
            
            // Notify user
            showNotification('Settings saved and applied', 'success');
            
            // Close modal
            settingsModal.style.display = 'none';
        });
        
        // Load saved settings on page load
        function loadSavedSettings() {
            const savedFontSize = localStorage.getItem('chat_font_size');
            const savedResponseStyle = localStorage.getItem('response_style');
            
            // Apply saved font size if exists
            if (savedFontSize) {
                const mainContent = document.querySelector('.main-content');
                mainContent.classList.remove('font-small', 'font-medium', 'font-large');
                mainContent.classList.add(`font-${savedFontSize}`);
                
                // Check the appropriate radio button
                document.getElementById(`font-${savedFontSize}`).checked = true;
            }
            
            // Set saved response style if exists
            if (savedResponseStyle) {
                document.getElementById(`style-${savedResponseStyle}`).checked = true;
            }
        }
        
        // Call loadSavedSettings on page load
        loadSavedSettings();
        
        // Suggestion chips functionality
        const suggestionChips = document.querySelectorAll('.suggestion-chip');
        suggestionChips.forEach(chip => {
            chip.addEventListener('click', function() {
                const question = this.textContent;
                sendMessage(question);
            });
        });
        
        // Chat functionality
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-message');
        const chatMessages = document.getElementById('chat-messages');
        
        // Flag to prevent auto-saving when loading from history
        window.isLoadingFromHistory = false;

        // Helper function to get all text and element nodes for animation
        function getAllTextNodes(node) {
            const allNodes = [];
            
            function traverse(currentNode) {
                // If it's an element node, clone it and process its children
                if (currentNode.nodeType === 1) { // Element node
                    const clonedNode = currentNode.cloneNode(false);
                    allNodes.push({ type: 'element', node: clonedNode });
                    
                    // Process children
                    for (const child of currentNode.childNodes) {
                        traverse(child);
                    }
                    
                    // Add a closing tag marker if needed (for block elements)
                    if (['P', 'DIV', 'UL', 'OL', 'LI', 'BLOCKQUOTE', 'PRE', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(currentNode.nodeName)) {
                        allNodes.push({ type: 'closeElement', node: currentNode.nodeName });
                    }
                } 
                // If it's a text node with content, split it into characters
                else if (currentNode.nodeType === 3 && currentNode.textContent.trim() !== '') { // Text node with content
                    const text = currentNode.textContent;
                    const words = text.split(' ');
                    
                    for (let i = 0; i < words.length; i++) {
                        allNodes.push({ 
                            type: 'text', 
                            content: words[i] + (i < words.length - 1 ? ' ' : '')
                        });
                    }
                }
            }
            
            for (const child of node.childNodes) {
                traverse(child);
            }
            
            return allNodes;
        }
        
        // Typewriter effect function
        function typewriterEffect(container, nodes, index, speed) {
            // Remove existing cursor if any
            const existingCursor = container.querySelector('.cursor-blink');
            if (existingCursor) {
                existingCursor.remove();
            }
            
            if (index >= nodes.length) {
                // Add blinking cursor at the end that stays for a while
                const cursor = document.createElement('span');
                cursor.className = 'cursor-blink';
                container.appendChild(cursor);
                
                // Remove cursor after a while
                setTimeout(() => {
                    cursor.remove();
                }, 5000);
                return;
            }
            
            const currentItem = nodes[index];
            
            if (currentItem.type === 'element') {
                container.appendChild(currentItem.node);
                typewriterEffect(currentItem.node, nodes, index + 1, speed);
            } else if (currentItem.type === 'closeElement') {
                // Move back to parent for next insertions
                typewriterEffect(container.parentNode, nodes, index + 1, speed);
            } else if (currentItem.type === 'text') {
                const textSpan = document.createElement('span');
                textSpan.textContent = currentItem.content;
                textSpan.style.opacity = '0';
                container.appendChild(textSpan);
                
                // Add blinking cursor after the text
                const cursor = document.createElement('span');
                cursor.className = 'cursor-blink';
                container.appendChild(cursor);
                
                // Fade in the text
                setTimeout(() => {
                    textSpan.style.transition = 'opacity 0.1s ease-in-out';
                    textSpan.style.opacity = '1';
                    
                    // Process next node with a slight delay
                    setTimeout(() => {
                        typewriterEffect(container, nodes, index + 1, speed);
                    }, speed);
                }, 10);
            }
            
            // Scroll to keep the latest text visible
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Function to add message to chat with markdown support
        function addMessage(text, isUser = false, animate = false) {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const timeString = `Hari ini, ${hours}:${minutes}`;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user' : 'message';
            
            // Format text with markdown for AI responses
            const formattedText = isUser ? text : md.render(text);
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="${isUser ? 'fas fa-user' : 'fas fa-robot'}"></i>
                </div>
                <div class="message-content">
                    <div class="message-text">${animate ? '' : formattedText}</div>
                    <div class="message-time">${timeString}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Apply typewriter effect for AI messages if animate is true
            if (animate && !isUser) {
                const messageTextDiv = messageDiv.querySelector('.message-text');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = formattedText;
                
                // Get all DOM nodes from the formatted HTML
                const allNodes = getAllTextNodes(tempDiv);
                messageTextDiv.innerHTML = '';
                
                typewriterEffect(messageTextDiv, allNodes, 0, 15);
            }
            
            // Auto-save chat after adding a message (if not loading from history)
            if (!window.isLoadingFromHistory) {
                saveChatHistory();
            }
        }
        
        // Function to send message (now accepts a custom message parameter)
        async function sendMessage(customMessage) {
            const message = customMessage || chatInput.value.trim();
            
            if (message) {
                try {
                    // Add user message to chat
                    addMessage(message, true);
                    
                    // Clear input if it was from the input field
                    if (!customMessage) {
                        chatInput.value = '';
                    }
                    
                    // Get and add AI response
                    const aiResponse = await getAIResponse(message);
                    addMessage(aiResponse, false, true); // Set animate to true
                    
                    // Check if session needs to be refreshed (if response contains a signal)
                    if (aiResponse.includes('session expired') || aiResponse.includes('login again')) {
                        showErrorNotification('Sesi Anda mungkin telah berakhir. Kami akan mencoba menyegarkan halaman.');
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                    }
                } catch (error) {
                    console.error('Error in sendMessage:', error);
                    addMessage('Terjadi kesalahan saat berkomunikasi dengan server. Silakan coba lagi.', false);
                }
            }
        }
        
        // Modified function to get AI response
        async function getAIResponse(message, retryCount = 0) {
            const maxRetries = 2; // Maximum retry attempts
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                console.log('Sending chat request to server...');
                
                // Get user's response style preference
                const responseStyle = localStorage.getItem('response_style') || 'balanced';
                
                // Prepare request payload
                const payload = { 
                    message: message,
                    preferences: {
                        response_style: responseStyle
                    }
                };
                
                // Call the server API endpoint
                const response = await fetch("{{ url_for('views.chat') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-Response-Style': responseStyle
                    },
                    body: JSON.stringify(payload),
                    credentials: 'same-origin'
                });
                
                console.log(`Server response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error(`API Error (${response.status}):`, errorData);
                    
                    // Handle different error types
                    if (response.status === 401) {
                        hideTypingIndicator();
                        showErrorNotification('Sesi Anda telah berakhir. Silakan login kembali.');
                        
                        // Redirect to login page after a short delay
                        setTimeout(() => {
                            window.location.href = '/login?next=/tutors';
                        }, 2000);
                        return 'Redirecting to login page...';
                    }
                    
                    // Show specific error messages based on error_type
                    if (errorData.error_type) {
                        switch(errorData.error_type) {
                            case 'auth':
                                showErrorNotification('Autentikasi API gagal. Hubungi administrator untuk pembaruan API key.');
                                return 'Masalah autentikasi dengan layanan AI. Administrator telah diberitahu.';
                                
                            case 'model_unavailable':
                                showErrorNotification('Model AI yang diminta tidak tersedia. Coba model lain di pengaturan.');
                                return 'Model AI yang diminta tidak tersedia atau memerlukan kredit tambahan. Silakan gunakan model yang berbeda.';
                                
                            case 'connectivity':
                                showErrorNotification('Masalah koneksi internet. Periksa koneksi Anda dan coba lagi.');
                                return 'Sepertinya ada masalah dengan koneksi internet. Pastikan Anda terhubung dan coba lagi.';
                                
                            case 'rate_limit':
                                showErrorNotification('Batas penggunaan AI tercapai. Coba lagi nanti.');
                                return 'Batas penggunaan AI tercapai. Silakan tunggu beberapa saat dan coba lagi nanti.';
                                
                            default:
                                // Use the more specific error message from the server
                                showErrorNotification(errorData.message || 'Terjadi kesalahan pada server.');
                        }
                    }
                    
                    // For 500 errors or other server errors, try to retry
                    if (response.status === 500 && retryCount < maxRetries) {
                        console.log(`Retry attempt ${retryCount + 1} of ${maxRetries}...`);
                        hideTypingIndicator();
                        
                        // Wait a moment before retrying (increasing delay with each retry)
                        await new Promise(r => setTimeout(r, 1000 * (retryCount + 1)));
                        
                        // Recursive retry with incremented counter
                        return await getAIResponse(message, retryCount + 1);
                    }
                    
                    throw new Error(errorData.message || `Server error (${response.status})`);
                }
                
                const data = await response.json();
                console.log('Response data received:', data.success ? 'Success' : 'Failed');
                
                if (!data.success) {
                    throw new Error(data.message || 'Unknown error');
                }
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Return the AI response
                return data.response;
            } catch (error) {
                console.error('Error getting AI response:', error);
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // If all retries failed, show a notification to the user
                if (retryCount >= maxRetries) {
                    showErrorNotification('Terjadi masalah saat menghubungi AI. Silakan coba lagi nanti.');
                }
                
                // Return error message to display in chat
                return `Maaf, terjadi kesalahan dalam memproses permintaan Anda: ${error.message || 'Unknown error'}`;
            }
        }
        
        // Function to show typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message-typing';
            typingDiv.id = 'typing-indicator';
            
            typingDiv.innerHTML = `                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Function to hide typing indicator
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // Function to show error notification
        function showErrorNotification(message) {
            showNotification(message, 'error');
        }
        
        // Function to show notification
        function showNotification(message, type = 'info') {
            const flashMessages = document.querySelector('.flash-messages');
            if (!flashMessages) return;
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            flashMessages.appendChild(alert);
            
            // Auto-remove notification after 3 seconds
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
        
        // Send message on button click
        sendButton.addEventListener('click', () => sendMessage());
        
        // Send message on Enter key
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Clear chat functionality - Updated to also clear current chat ID
        document.getElementById('clear-chat-btn').addEventListener('click', function() {
            // Call API to clear chat history on the server
            fetch("{{ url_for('views.clear_chat') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove all messages except the welcome message
                    const messages = chatMessages.querySelectorAll('.message');
                    for (let i = 1; i < messages.length; i++) {
                        messages[i].remove();
                    }
                    
                    // Clear current chat ID
                    localStorage.removeItem('skillora_current_chat_id');
                    
                    // Also remove typing indicator if present
                    hideTypingIndicator();
                    
                    // Show success notification
                    showNotification('Chat cleared', 'success');
                } else {
                    console.error('Error clearing chat history:', data.message);
                }
            })
            .catch(error => {
                console.error('Error clearing chat history:', error);
            });
        });
        
        // Function to save the current chat history
        function saveChatHistory() {
            // Get all messages except the welcome message
            const messages = chatMessages.querySelectorAll('.message');
            if (messages.length <= 1) return; // Don't save if only welcome message exists
            
            const chatData = [];
            
            // Start from index 1 to skip the welcome message
            for (let i = 1; i < messages.length; i++) {
                const message = messages[i];
                const isUser = message.classList.contains('user');
                const text = message.querySelector('.message-text').innerHTML;
                const time = message.querySelector('.message-time').textContent;
                
                chatData.push({
                    isUser: isUser,
                    text: isUser ? message.querySelector('.message-text').textContent : text, // For user messages, get plain text
                    time: time
                });
            }
            
            // Generate a title from the first user message
            let title = "Chat ";
            for (let i = 0; i < chatData.length; i++) {
                if (chatData[i].isUser) {
                    // Get first 4-5 words or 30 characters
                    const words = chatData[i].text.split(' ');
                    title = words.slice(0, Math.min(5, words.length)).join(' ');
                    if (title.length > 30) {
                        title = title.substring(0, 30) + '...';
                    }
                    break;
                }
            }
            
            // Add date and time to the title
            const now = new Date();
            const timestamp = now.toISOString();
            
            // Create a chat history entry
            const historyEntry = {
                id: 'chat_' + Date.now(),
                title: title,
                timestamp: timestamp,
                preview: chatData[0].text.substring(0, 100) + (chatData[0].text.length > 100 ? '...' : ''),
                messages: chatData
            };
            
            // Get existing history or initialize new array
            let chatHistory = JSON.parse(localStorage.getItem('skillora_chat_history') || '[]');
            
            // Check if we're continuing an existing chat
            const currentChatId = localStorage.getItem('skillora_current_chat_id');
            
            if (currentChatId) {
                // Find and update the existing chat
                const index = chatHistory.findIndex(item => item.id === currentChatId);
                if (index !== -1) {
                    historyEntry.id = currentChatId;
                    historyEntry.title = chatHistory[index].title; // Keep the original title
                    chatHistory[index] = historyEntry;
                } else {
                    // Add as new if not found
                    chatHistory.unshift(historyEntry);
                    localStorage.setItem('skillora_current_chat_id', historyEntry.id);
                }
            } else {
                // Add new chat to the beginning of the array
                chatHistory.unshift(historyEntry);
                localStorage.setItem('skillora_current_chat_id', historyEntry.id);
            }
            
            // Limit history to 20 entries
            if (chatHistory.length > 20) {
                chatHistory = chatHistory.slice(0, 20);
            }
            
            // Save to localStorage
            localStorage.setItem('skillora_chat_history', JSON.stringify(chatHistory));
        }
        
        // Function to load chat history list
        function loadChatHistoryList() {
            const historyList = document.getElementById('history-list');
            const historyEmpty = document.getElementById('history-empty');
            
            // Get chat history from localStorage
            const chatHistory = JSON.parse(localStorage.getItem('skillora_chat_history') || '[]');
            
            // Show empty state if no history
            if (chatHistory.length === 0) {
                historyEmpty.style.display = 'flex';
                historyList.innerHTML = '';
                return;
            }
            
            // Hide empty state and populate list
            historyEmpty.style.display = 'none';
            historyList.innerHTML = '';
            
            chatHistory.forEach(entry => {
                const date = new Date(entry.timestamp);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const historyItem = document.createElement('div');
                historyItem.className = 'chat-history-item';
                historyItem.setAttribute('data-id', entry.id);
                
                historyItem.innerHTML = `
                    <div class="chat-history-details">
                        <div class="chat-history-title">${entry.title}</div>
                        <div class="chat-history-date">${formattedDate}</div>
                        <div class="chat-history-preview">${entry.preview}</div>
                    </div>
                    <div class="chat-history-actions">
                        <button class="chat-history-action delete-history" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                // Add click event to load this chat
                historyItem.addEventListener('click', function(e) {
                    // Ignore if click was on delete button
                    if (e.target.closest('.delete-history')) return;
                    
                    loadChatFromHistory(entry.id);
                    historyModal.style.display = 'none';
                });
                
                // Add delete button event
                const deleteBtn = historyItem.querySelector('.delete-history');
                deleteBtn.addEventListener('click', function() {
                    deleteChatHistory(entry.id);
                });
                
                historyList.appendChild(historyItem);
            });
        }
        
        // Function to load a specific chat from history
        function loadChatFromHistory(chatId) {
            const chatHistory = JSON.parse(localStorage.getItem('skillora_chat_history') || '[]');
            const chatEntry = chatHistory.find(item => item.id === chatId);
            
            if (!chatEntry) return;
            
            // Set current chat ID
            localStorage.setItem('skillora_current_chat_id', chatId);
            
            // Clear chat except welcome message
            const messages = chatMessages.querySelectorAll('.message');
            for (let i = 1; i < messages.length; i++) {
                messages[i].remove();
            }
            
            // Set flag to prevent auto-saving while loading
            window.isLoadingFromHistory = true;
            
            // Add messages from history
            chatEntry.messages.forEach(msg => {
                addMessage(msg.text, msg.isUser);
            });
            
            // Reset flag
            window.isLoadingFromHistory = false;
            
            // Show notification
            showNotification('Chat history loaded', 'success');
        }
        
        // Function to delete chat history entry
        function deleteChatHistory(chatId) {
            let chatHistory = JSON.parse(localStorage.getItem('skillora_chat_history') || '[]');
            
            // Filter out the selected chat
            chatHistory = chatHistory.filter(item => item.id !== chatId);
            
            // Save updated history
            localStorage.setItem('skillora_chat_history', JSON.stringify(chatHistory));
            
            // If we're deleting the current chat, clear the current chat ID
            if (localStorage.getItem('skillora_current_chat_id') === chatId) {
                localStorage.removeItem('skillora_current_chat_id');
            }
            
            // Reload the history list
            loadChatHistoryList();
            
            // Show notification
            showNotification('Chat deleted', 'success');
        }
        
        // Initialize current chat if available
        const currentChatId = localStorage.getItem('skillora_current_chat_id');
        if (currentChatId) {
            // Check if there are already messages (avoid double loading)
            const messages = chatMessages.querySelectorAll('.message');
            if (messages.length <= 1) { // Only welcome message
                loadChatFromHistory(currentChatId);
            }
        }
        
        // Animate elements on load
        if (typeof gsap !== 'undefined') {
            gsap.from('.chat-container', {
                y: 50,
                opacity: 0,
                duration: 0.8,
                ease: 'power3.out'
            });
            
            gsap.from('.message', {
                y: 30,
                opacity: 0,
                duration: 0.6,
                stagger: 0.2,
                ease: 'power3.out',
                delay: 0.3
            });
        }

        // Image fullscreen functionality
        document.addEventListener('click', function(e) {
            // Check if clicked element is a message image
            if (e.target.classList.contains('message-image')) {
                const imageUrl = e.target.src;
                
                // Create fullscreen container
                const fullscreen = document.createElement('div');
                fullscreen.className = 'image-fullscreen';
                
                // Create image element
                const img = document.createElement('img');
                img.src = imageUrl;
                
                // Create close button
                const closeBtn = document.createElement('div');
                closeBtn.className = 'image-fullscreen-close';
                closeBtn.innerHTML = '×';
                closeBtn.addEventListener('click', function() {
                    fullscreen.remove();
                });
                
                // Append elements to container
                fullscreen.appendChild(img);
                fullscreen.appendChild(closeBtn);
                
                // Add click event to close on background click
                fullscreen.addEventListener('click', function(e) {
                    if (e.target === fullscreen) {
                        fullscreen.remove();
                    }
                });
                
                // Add to document
                document.body.appendChild(fullscreen);
            }
        });

        // Ensure JavaScript properly initializes the chat interface
        const chatMessagesContainer = document.getElementById('chat-messages');
        
        if (chatMessagesContainer) {
            // Clear any potential debugging attributes or classes
            chatMessagesContainer.setAttribute('style', '');
            
            // Ensure the chat container has proper sizing
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                chatContainer.style.minHeight = '500px';
                chatContainer.style.height = 'calc(100vh - 170px)';
            }
        }
        
        console.log("Chat interface initialized and fixed");
    });
    </script>
</body>
</html> 
