<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Skillora - My Courses">
    <meta name="theme-color" content="#6200ea">
    <title>Skillora - My Courses</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/module-styles.css') }}">
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <a href="{{ url_for('views.home') }}" class="sidebar-logo">
                <div class="logo-circle">
                    <div class="logo-letter">S</div>
                </div>
                <span class="logo-text">Skillora</span>
            </a>
            
            <div class="sidebar-menu">
                <p class="menu-category">Main</p>
                <a href="{{ url_for('views.home') }}" class="menu-item">
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>
                <a href="{{ url_for('views.learning_path') }}" class="menu-item">
                    <i class="fas fa-graduation-cap"></i>
                    Learning Path
                </a>
                <a href="{{ url_for('views.my_courses') }}" class="menu-item active">
                    <i class="fas fa-book"></i>
                    My Courses
                </a>
                <a href="{{ url_for('views.schedule') }}" class="menu-item">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule
                </a>
                
                <p class="menu-category">Resources</p>
                <a href="{{ url_for('views.library') }}" class="menu-item">
                    <i class="fas fa-book-open"></i>
                    Library
                </a>
                <a href="{{ url_for('views.tutors') }}" class="menu-item">
                    <i class="fas fa-chalkboard-teacher"></i>
                    AI Tutor
                </a>
                <a href="{{ url_for('views.progress') }}" class="menu-item">
                    <i class="fas fa-chart-line"></i>
                    Progress
                </a>
                
                <p class="menu-category">Account</p>
                <a href="{{ url_for('views.profile') }}" class="menu-item">
                    <i class="fas fa-user-circle"></i>
                    Profile
                </a>
                <a href="{{ url_for('views.settings') }}" class="menu-item">
                    <i class="fas fa-cog"></i>
                    Settings
                </a>
                <a href="{{ url_for('views.help') }}" class="menu-item">
                    <i class="fas fa-question-circle"></i>
                    Help
                </a>
            </div>
            
            <div class="user-profile">
                <div class="user-avatar">
                    {{ user.first_name[0] }}
                </div>
                <div class="user-info">
                    <div class="user-name">{{ user.first_name }}</div>
                    <div class="user-email">{{ user.email }}</div>
                </div>
                <a href="{{ url_for('auth.logout') }}" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
                </div>
            {% endif %}
            {% endwith %}
            
            <!-- Survey Required Notice - This will never be visible to users because we redirect in the view,
                 but it's here as an extra precaution in case of routing issues -->
            {% if not user.is_survey_completed %}
            <div class="survey-required-notice">
                <div class="notice-content">
                    <i class="fas fa-exclamation-circle notice-icon"></i>
                    <div class="notice-text">
                        <h3>Complete Your CS Interest Survey</h3>
                        <p>Before accessing your courses, please complete the CS interest survey to help us personalize your experience.</p>
                    </div>
                    <a href="{{ url_for('views.cs_interest_survey') }}" class="btn btn-primary">Take Survey Now</a>
                </div>
            </div>
            {% endif %}
            
            <!-- Page Header -->
            <div class="dashboard-header">
                <div class="welcome-text">
                    <h1>My Courses</h1>
                    <p>Manage and track all your learning courses</p>
                </div>
                <div class="header-actions">
                    <button class="action-btn tooltip">
                        <i class="fas fa-search"></i>
                        <span class="tooltip-text">Search courses</span>
                    </button>
                    <button class="action-btn tooltip">
                        <i class="fas fa-filter"></i>
                        <span class="tooltip-text">Filter courses</span>
                    </button>
                </div>
            </div>
            
            <!-- Course Filter & Categories -->
            <div class="course-filter-container enhanced-card">
                <div class="course-filter-tabs">
                    <button class="filter-tab active">All Courses</button>
                    <button class="filter-tab">In Progress</button>
                    <button class="filter-tab">Completed</button>
                    <button class="filter-tab">Bookmarked</button>
                    <button class="filter-tab">Recently Added</button>
                </div>
                
                <div class="course-filter-actions">
                    <div class="course-sort">
                        <span>Sort by:</span>
                        <select class="sort-select">
                            <option value="recent">Recently Accessed</option>
                            <option value="progress">Progress</option>
                            <option value="name">Name</option>
                            <option value="date">Date Added</option>
                        </select>
                    </div>
                    
                    <div class="course-view-toggle">
                        <button class="view-btn active" data-view="grid">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button class="view-btn" data-view="list">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- In Progress Courses -->
            <div class="course-section">
                <div class="section-header">
                    <h2 class="section-title">In Progress</h2>
                    <span class="course-count">{{ in_progress_courses|length }} courses</span>
                </div>
                
                <div class="courses-grid">
                    {% if in_progress_courses %}
                        {% for course in in_progress_courses %}
                            <div class="course-card enhanced-card" data-course-id="{{ course.id }}">
                        <div class="course-image animated-gradient">
                                    <div class="course-category">{{ course.category_name }}</div>
                            <div class="course-actions">
                                        <button class="course-action-btn tooltip bookmark-btn" data-course-id="{{ course.id }}">
                                            <i class="{% if course.is_bookmarked %}fas{% else %}far{% endif %} fa-bookmark"></i>
                                            <span class="tooltip-text">{% if course.is_bookmarked %}Bookmarked{% else %}Add Bookmark{% endif %}</span>
                                </button>
                            </div>
                        </div>
                        <div class="course-content">
                                    <h3 class="course-title">{{ course.title }}</h3>
                                    <p class="course-description">{{ course.description }}</p>
                            <div class="course-meta">
                                <div class="course-level">
                                    <i class="fas fa-signal"></i>
                                            <span>{{ course.level }}</span>
                                        </div>
                                        <div class="course-modules">
                                            <i class="fas fa-layer-group"></i>
                                            <span>{{ course.total_modules }} modules</span>
                                        </div>
                                        <div class="course-completion">
                                            <i class="fas fa-tasks"></i>
                                            <span>{{ course.completed_modules }}/{{ course.total_modules }} completed</span>
                                </div>
                            </div>
                            <div class="course-footer">
                                <div class="course-progress">
                                            <div class="progress-bar" data-progress="{{ course.progress }}"></div>
                                </div>
                                        <span class="course-percentage">{{ course.progress }}%</span>
                            </div>
                                    <button class="btn btn-primary start-learning-btn" data-course-id="{{ course.id }}">Start Learning</button>
                                </div>
                            </div>
                            
                            <!-- Course Modules Section (Hidden by default) -->
                            <div class="course-modules-container" id="modules-for-{{ course.id }}" style="display: none;">
                                <div class="modules-header">
                                    <h3>{{ course.title }} - Modules</h3>
                                    <button class="close-modules-btn"><i class="fas fa-times"></i></button>
                                </div>
                                
                                <div class="modules-grid">
                                    {% if course.modules %}
                                        {% for module in course.modules %}
                                            <div class="module-card enhanced-card" data-module-id="{{ module.id }}">
                                                <div class="module-header">
                                                    <span class="module-number">Module {{ module.order }}</span>
                                                    <span class="module-status">
                                                        {% if module in completed_modules %}
                                                            <i class="fas fa-check-circle"></i> Completed
                                                        {% else %}
                                                            <i class="far fa-circle"></i> Not Started
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <h4 class="module-title">{{ module.title }}</h4>
                                                <p class="module-description">{{ module.description }}</p>
                                                
                                                <!-- Videos Container -->
                                                <div class="module-videos">
                                                    {% if module.get_youtube_links() %}
                                                        <h5><i class="fab fa-youtube"></i> Learning Materials</h5>
                                                        <div class="video-links">
                                                            {% for url in module.get_youtube_links() %}
                                                                <a href="{{ url }}" target="_blank" class="video-link">
                                                                    <i class="fas fa-play-circle"></i> Video {{ loop.index }}
                                                                </a>
                                                            {% endfor %}
                            </div>
                                                    {% else %}
                                                        <div class="video-status auto-load-content" data-module-id="{{ module.id }}">
                                                            <p><i class="fas fa-spinner fa-spin"></i> Loading learning content...</p>
                                                            <p class="small text-muted">This may take a moment. Please wait.</p>
                                                        </div>
                                                    {% endif %}
                    </div>
                    
                                                <!-- Quiz Container -->
                                                <div class="module-quiz">
                                                    {% if module.quiz %}
                                                        <h5><i class="fas fa-question-circle"></i> Assessment</h5>
                                                        <button class="btn btn-sm btn-secondary start-quiz-btn" data-quiz-id="{{ module.quiz.id }}">
                                                            Take Quiz
                                </button>
                                                    {% else %}
                                                        {% if module.get_youtube_links() %}
                                                            <div class="quiz-status">
                                                                <p>Quiz will be available after content is reviewed</p>
                            </div>
                                                        {% endif %}
                                                    {% endif %}
                    </div>
                    
                                                <div class="module-actions">
                                                    {% if module.get_youtube_links() %}
                                                        <button class="btn btn-primary btn-start-module" data-module-id="{{ module.id }}" data-course-id="{{ course.id }}">
                                                            Start Learning
                                </button>
                                                    {% endif %}
                            </div>
                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="no-modules-message">
                                            <p>No modules have been created for this course yet.</p>
                                            <button class="btn btn-primary generate-modules-btn" data-course-id="{{ course.id }}">
                                                Generate Course Content
                                            </button>
                                </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-courses-message">
                            <p>You haven't started any courses yet.</p>
                            <a href="{{ url_for('views.learning_path') }}" class="btn btn-primary">
                                Set Up Your Learning Path
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Completed Courses -->
            <div class="course-section">
                <div class="section-header">
                    <h2 class="section-title">Completed</h2>
                    <span class="course-count">{{ completed_courses|length }} courses</span>
                </div>
                
                <div class="courses-grid">
                    {% if completed_courses %}
                        {% for course in completed_courses %}
                    <div class="course-card enhanced-card completed">
                        <div class="course-image animated-gradient">
                                    <div class="course-category">{{ course.category_name }}</div>
                            <div class="completion-badge">
                                <i class="fas fa-check-circle"></i>
                                <span>Completed</span>
                            </div>
                            <div class="course-actions">
                                <button class="course-action-btn tooltip">
                                    <i class="fas fa-certificate"></i>
                                    <span class="tooltip-text">View Certificate</span>
                                </button>
                                <button class="course-action-btn tooltip">
                                    <i class="fas fa-redo"></i>
                                    <span class="tooltip-text">Restart Course</span>
                                </button>
                            </div>
                        </div>
                        <div class="course-content">
                                    <h3 class="course-title">{{ course.title }}</h3>
                                    <p class="course-description">{{ course.description }}</p>
                            <div class="course-meta">
                                <div class="course-level">
                                    <i class="fas fa-signal"></i>
                                            <span>{{ course.level }}</span>
                                        </div>
                                        <div class="course-modules">
                                            <i class="fas fa-layer-group"></i>
                                            <span>{{ course.total_modules }} modules</span>
                                        </div>
                                        <div class="course-completion">
                                            <i class="fas fa-tasks"></i>
                                            <span>{{ course.completed_modules }}/{{ course.total_modules }} completed</span>
                                </div>
                            </div>
                            <div class="course-footer">
                                <div class="course-progress">
                                    <div class="progress-bar" style="width: 100%"></div>
                                </div>
                                <span class="course-percentage">100%</span>
                            </div>
                            <div class="course-completion-date">
                                <i class="fas fa-calendar-check"></i>
                                        <span>Completed on {{ course.completion_date|default('Recently') }}</span>
                            </div>
                                    <button class="btn btn-secondary course-expand-btn" data-course-id="{{ course.id }}">Review Materials</button>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-courses-message">
                            <p>You haven't completed any courses yet.</p>
                            <p>Start learning to see your achievements here!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Recommended Courses -->
            <div class="course-section">
                <div class="section-header">
                    <h2 class="section-title">Recommended For You</h2>
                    <a href="#" class="view-all">View All</a>
                </div>
                
                <div class="courses-grid">
                    <!-- Recommended Course 1 -->
                    <div class="course-card enhanced-card new">
                        <div class="course-image animated-gradient">
                            <div class="course-category">Deep Learning</div>
                            <div class="course-actions">
                                <button class="course-action-btn tooltip">
                                    <i class="far fa-bookmark"></i>
                                    <span class="tooltip-text">Add Bookmark</span>
                                </button>
                            </div>
                        </div>
                        <div class="course-content">
                            <h3 class="course-title">Deep Learning Specialization</h3>
                            <p class="course-description">Master deep learning techniques with neural networks and TensorFlow.</p>
                            <div class="course-meta">
                                <div class="course-rating">
                                    <i class="fas fa-star"></i>
                                    <span>4.9</span>
                                </div>
                                <div class="course-students">
                                    <i class="fas fa-users"></i>
                                    <span>4.5k</span>
                                </div>
                                <div class="course-level">
                                    <i class="fas fa-signal"></i>
                                    <span>Advanced</span>
                                </div>
                            </div>
                            <div class="course-recommendation-reason">
                                <i class="fas fa-lightbulb"></i>
                                <span>Recommended based on your interest in Machine Learning</span>
                            </div>
                            <button class="btn btn-primary">Enroll Now</button>
                        </div>
                    </div>
                    
                    <!-- Recommended Course 2 -->
                    <div class="course-card enhanced-card">
                        <div class="course-image animated-gradient">
                            <div class="course-category">Full-Stack</div>
                            <div class="course-actions">
                                <button class="course-action-btn tooltip">
                                    <i class="far fa-bookmark"></i>
                                    <span class="tooltip-text">Add Bookmark</span>
                                </button>
                            </div>
                        </div>
                        <div class="course-content">
                            <h3 class="course-title">Full-Stack Web Development</h3>
                            <p class="course-description">Comprehensive course covering front-end and back-end technologies.</p>
                            <div class="course-meta">
                                <div class="course-rating">
                                    <i class="fas fa-star"></i>
                                    <span>4.8</span>
                                </div>
                                <div class="course-students">
                                    <i class="fas fa-users"></i>
                                    <span>3.2k</span>
                                </div>
                                <div class="course-level">
                                    <i class="fas fa-signal"></i>
                                    <span>Intermediate</span>
                                </div>
                            </div>
                            <div class="course-recommendation-reason">
                                <i class="fas fa-lightbulb"></i>
                                <span>Recommended based on your interest in React</span>
                            </div>
                            <button class="btn btn-primary">Enroll Now</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quiz Modal -->
    <div class="quiz-modal" id="quiz-modal" style="display: none;">
        <div class="quiz-modal-content enhanced-card">
            <div class="quiz-modal-header">
                <h3 id="quiz-title">Quiz Title</h3>
                <button class="close-quiz-btn"><i class="fas fa-times"></i></button>
            </div>
            <div class="quiz-modal-body">
                <div id="quiz-instructions">
                    <p>Complete the following questions to test your knowledge. You need 70% to pass.</p>
                </div>
                <form id="quiz-form">
                    <div id="quiz-questions-container">
                        <!-- Questions will be loaded here dynamically -->
                    </div>
                    <div class="quiz-navigation">
                        <button type="button" id="prev-question" class="btn btn-secondary">Previous</button>
                        <span id="question-indicator">Question 1 of 5</span>
                        <button type="button" id="next-question" class="btn btn-secondary">Next</button>
                    </div>
                    <button type="submit" class="btn btn-primary btn-submit-quiz">Submit Quiz</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- JS Files -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle sidebar on mobile
            const sidebar = document.querySelector('.sidebar');
            const menuToggle = document.querySelector('.mobile-menu-toggle');
            
            if (menuToggle) {
                menuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    
                    // Toggle between hamburger and close icon
                    const icon = this.querySelector('i');
                    if (sidebar.classList.contains('active')) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                    
                    document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
                });
            }
            
            // Tab switching functionality
            const filterTabs = document.querySelectorAll('.filter-tab');
            filterTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    filterTabs.forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                // Filter courses based on the selected tab
                const tabText = this.textContent.trim().toLowerCase();
                filterCourses(tabText);
            });
        });
        
        // Function to filter courses based on tab
        function filterCourses(filter) {
            const courseCards = document.querySelectorAll('.course-card');
            
            courseCards.forEach(card => {
                const courseSection = card.closest('.course-section');
                const isCompleted = card.classList.contains('completed');
                const isBookmarked = card.querySelector('.fa-bookmark').classList.contains('fas');
                
                // Get creation date (would be data-attribute in real implementation)
                const isRecent = true; // Placeholder for recent check
                
                // Apply filter logic
                if (filter === 'all courses') {
                    card.style.display = 'flex';
                } else if (filter === 'in progress' && !isCompleted) {
                    card.style.display = 'flex';
                } else if (filter === 'completed' && isCompleted) {
                    card.style.display = 'flex';
                } else if (filter === 'bookmarked' && isBookmarked) {
                    card.style.display = 'flex';
                } else if (filter === 'recently added' && isRecent) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // Toggle bookmark
        const bookmarkBtns = document.querySelectorAll('.bookmark-btn');
        bookmarkBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                
                const courseId = this.dataset.courseId;
                const iconElement = this.querySelector('i');
                const tooltipText = this.querySelector('.tooltip-text');
                
                // Toggle bookmark icon
                if (iconElement.classList.contains('far')) {
                    iconElement.classList.remove('far');
                    iconElement.classList.add('fas');
                    tooltipText.textContent = 'Bookmarked';
                    
                    // Send bookmark request to server
                    updateBookmark(courseId, true);
                } else {
                    iconElement.classList.remove('fas');
                    iconElement.classList.add('far');
                    tooltipText.textContent = 'Add Bookmark';
                    
                    // Send unbookmark request to server
                    updateBookmark(courseId, false);
                }
            });
        });
        
        // Update bookmark status on server
        function updateBookmark(courseId, isBookmarked) {
            fetch('/update_bookmark', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    course_id: courseId,
                    is_bookmarked: isBookmarked
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Failed to update bookmark:', data.error);
                }
            })
            .catch(error => {
                console.error('Error updating bookmark:', error);
            });
        }
        
        // Get all course expand buttons
        const courseExpandBtns = document.querySelectorAll('.course-expand-btn');
        const startLearningBtns = document.querySelectorAll('.start-learning-btn');
        const closeBtns = document.querySelectorAll('.close-modules-btn');
        
        // Start Learning button functionality
        startLearningBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const courseId = this.dataset.courseId;
                
                // Show loading state
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                this.disabled = true;
                
                // Fetch the course modules to find the first one
                fetch(`/api/course/${courseId}/modules`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.modules && data.modules.length > 0) {
                        // Redirect to the first module's learning interface
                        window.location.href = `/learning-interface/${courseId}/${data.modules[0].id}`;
                    } else {
                        // If no modules, expand the modules section to show the "Generate Course Content" button
                        const modulesContainer = document.getElementById(`modules-for-${courseId}`);
                        if (modulesContainer) {
                            modulesContainer.style.display = 'block';
                            // Reset button
                            this.innerHTML = 'Start Learning';
                            this.disabled = false;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching modules:', error);
                    // Reset button
                    this.innerHTML = 'Start Learning';
                    this.disabled = false;
                });
            });
        });
        
        // Course expand button functionality
        courseExpandBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const courseId = this.dataset.courseId;
                const modulesContainer = document.getElementById(`modules-for-${courseId}`);
                
                // Close any open module containers
                document.querySelectorAll('.course-modules-container').forEach(container => {
                    if (container.id !== `modules-for-${courseId}`) {
                        container.style.display = 'none';
                    }
                });
                
                // Toggle the clicked module container
                if (modulesContainer) {
                    modulesContainer.style.display = modulesContainer.style.display === 'none' ? 'block' : 'none';
                }
            });
        });
        
        // Close modules container
        closeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const container = this.closest('.course-modules-container');
                container.style.display = 'none';
            });
        });
        
        // Automatic content loading
        const autoLoadElements = document.querySelectorAll('.auto-load-content');
        autoLoadElements.forEach(element => {
            const moduleId = element.dataset.moduleId;
            
            // Send request to generate module content
            fetch(`/generate_module_content/${moduleId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create video links HTML
                    let linksHtml = '<h5><i class="fab fa-youtube"></i> Learning Materials</h5><div class="video-links">';
                    
                    data.urls.forEach((url, index) => {
                        linksHtml += `
                            <a href="${url}" target="_blank" class="video-link">
                                <i class="fas fa-play-circle"></i> Video ${index + 1}
                            </a>
                        `;
                    });
                    
                    linksHtml += '</div>';
                    
                    // Replace video status with links
                    const videosContainer = element.closest('.module-videos');
                    videosContainer.innerHTML = linksHtml;
                    
                    // Add a start learning button
                    const moduleCard = element.closest('.module-card');
                    const actionsDiv = moduleCard.querySelector('.module-actions');
                    actionsDiv.innerHTML = `
                        <button class="btn btn-primary btn-start-module" data-module-id="${moduleId}" data-course-id="${moduleCard.dataset.courseId}">
                            Start Learning
                        </button>
                    `;
                    
                    // Update quiz section
                    const quizSection = moduleCard.querySelector('.module-quiz');
                    quizSection.innerHTML = `
                        <div class="quiz-status">
                            <p>Quiz will be available after content is reviewed</p>
                        </div>
                    `;
                } else {
                    // Show error
                    element.innerHTML = `
                        <p><i class="fas fa-exclamation-circle"></i> Error finding content</p>
                        <button class="btn btn-sm btn-primary load-videos-btn" data-module-id="${moduleId}">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    `;
                    console.error('Failed to load videos:', data.error);
                }
            })
            .catch(error => {
                element.innerHTML = `
                    <p><i class="fas fa-exclamation-circle"></i> Error loading content</p>
                    <button class="btn btn-sm btn-primary load-videos-btn" data-module-id="${moduleId}">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                `;
                console.error('Error loading videos:', error);
            });
        });
        
        // Attach event listeners for "Try Again" buttons that might be created dynamically
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('load-videos-btn') || event.target.closest('.load-videos-btn')) {
                const button = event.target.classList.contains('load-videos-btn') ? 
                    event.target : event.target.closest('.load-videos-btn');
                const moduleId = button.dataset.moduleId;
                
                // Show loading state
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finding content...';
                button.disabled = true;
                
                // Send request to generate module content
                fetch(`/generate_module_content/${moduleId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Create video links HTML
                        let linksHtml = '<h5><i class="fab fa-youtube"></i> Learning Materials</h5><div class="video-links">';
                        
                        data.urls.forEach((url, index) => {
                            linksHtml += `
                                <a href="${url}" target="_blank" class="video-link">
                                    <i class="fas fa-play-circle"></i> Video ${index + 1}
                                </a>
                            `;
                        });
                        
                        linksHtml += '</div>';
                        
                        // Replace video status with links
                        const videosContainer = button.closest('.module-videos');
                        videosContainer.innerHTML = linksHtml;
                        
                        // Add a start learning button
                        const moduleCard = button.closest('.module-card');
                        const actionsDiv = moduleCard.querySelector('.module-actions');
                        actionsDiv.innerHTML = `
                            <button class="btn btn-primary btn-start-module" data-module-id="${moduleId}" data-course-id="${moduleCard.dataset.courseId}">
                                Start Learning
                            </button>
                        `;
                        
                        // Update quiz section
                        const quizSection = moduleCard.querySelector('.module-quiz');
                        quizSection.innerHTML = `
                            <div class="quiz-status">
                                <p>Quiz will be available after content is reviewed</p>
                            </div>
                        `;
                    } else {
                        // Show error
                        const videoStatus = button.closest('.video-status');
                        videoStatus.innerHTML = `
                            <p><i class="fas fa-exclamation-circle"></i> Error finding content</p>
                            <button class="btn btn-sm btn-primary load-videos-btn" data-module-id="${moduleId}">
                                <i class="fas fa-redo"></i> Try Again
                            </button>
                        `;
                        console.error('Failed to load videos:', data.error);
                    }
                })
                .catch(error => {
                    const videoStatus = button.closest('.video-status');
                    videoStatus.innerHTML = `
                        <p><i class="fas fa-exclamation-circle"></i> Error loading content</p>
                        <button class="btn btn-sm btn-primary load-videos-btn" data-module-id="${moduleId}">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    `;
                    console.error('Error loading videos:', error);
                });
            }
        });
        
        // Quiz functionality
        const startQuizBtns = document.querySelectorAll('.start-quiz-btn');
        const quizModal = document.getElementById('quiz-modal');
        const quizForm = document.getElementById('quiz-form');
        const quizTitle = document.getElementById('quiz-title');
        const questionsContainer = document.getElementById('quiz-questions-container');
        const closeQuizBtn = document.querySelector('.close-quiz-btn');
        
        // Quiz navigation
        const prevQuestionBtn = document.getElementById('prev-question');
        const nextQuestionBtn = document.getElementById('next-question');
        const questionIndicator = document.getElementById('question-indicator');
        
        let currentQuestionIndex = 0;
        let quizQuestions = [];
        
        startQuizBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const quizId = this.dataset.quizId;
                
                // Show loading state
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading quiz...';
                
                // Load quiz questions from server
                fetch(`/get_quiz/${quizId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Set quiz title
                        quizTitle.textContent = data.quiz.title;
                        
                        // Store questions
                        quizQuestions = data.questions;
                        
                        // Reset to first question
                        currentQuestionIndex = 0;
                        updateQuestionDisplay();
                        
                        // Show modal
                        quizModal.style.display = 'flex';
                    } else {
                        this.innerHTML = 'Take Quiz';
                        alert('Failed to load quiz: ' + data.error);
                    }
                })
                .catch(error => {
                    this.innerHTML = 'Take Quiz';
                    alert('Error loading quiz: ' + error);
                });
            });
        });
        
        // Close quiz modal
        if (closeQuizBtn) {
            closeQuizBtn.addEventListener('click', function() {
                quizModal.style.display = 'none';
            });
        }
        
        // Quiz navigation
        if (prevQuestionBtn) {
            prevQuestionBtn.addEventListener('click', function() {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    updateQuestionDisplay();
                }
            });
        }
        
        if (nextQuestionBtn) {
            nextQuestionBtn.addEventListener('click', function() {
                if (currentQuestionIndex < quizQuestions.length - 1) {
                    currentQuestionIndex++;
                    updateQuestionDisplay();
                }
            });
        }
        
        // Update question display
        function updateQuestionDisplay() {
            if (quizQuestions.length === 0) return;
            
            const question = quizQuestions[currentQuestionIndex];
            
            // Update question indicator
            questionIndicator.textContent = `Question ${currentQuestionIndex + 1} of ${quizQuestions.length}`;
            
            // Clear container
            questionsContainer.innerHTML = '';
            
            // Create question element
            const questionElement = document.createElement('div');
            questionElement.className = 'quiz-question';
            questionElement.dataset.questionId = question.id;
            questionElement.dataset.questionType = question.question_type;
            
            let questionHtml = `<h4 class="question-text">${question.question_text}</h4>`;
            
            // Add appropriate input based on question type
            if (question.question_type === 'multiple_choice') {
                const options = JSON.parse(question.options);
                questionHtml += '<div class="question-options">';
                
                options.forEach((option, index) => {
                    const optionId = `q${question.id}_option${index}`;
                    questionHtml += `
                        <div class="option">
                            <input type="radio" name="q${question.id}" id="${optionId}" value="${option}">
                            <label for="${optionId}">${option}</label>
                        </div>
                    `;
                });
                
                questionHtml += '</div>';
            } else if (question.question_type === 'fill_in_blank') {
                questionHtml += `
                    <div class="fill-blank">
                        <input type="text" name="q${question.id}" class="fill-blank-input" placeholder="Your answer">
                    </div>
                `;
            }
            
            questionElement.innerHTML = questionHtml;
            questionsContainer.appendChild(questionElement);
            
            // Update navigation buttons
            prevQuestionBtn.disabled = currentQuestionIndex === 0;
            nextQuestionBtn.disabled = currentQuestionIndex === quizQuestions.length - 1;
        }
        
        // Submit quiz
        if (quizForm) {
            quizForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Collect all answers
                const answers = {};
                
                quizQuestions.forEach(question => {
                    if (question.question_type === 'multiple_choice') {
                        const selectedOption = document.querySelector(`input[name="q${question.id}"]:checked`);
                        answers[question.id] = selectedOption ? selectedOption.value : null;
                    } else if (question.question_type === 'fill_in_blank') {
                        const input = document.querySelector(`input[name="q${question.id}"]`);
                        answers[question.id] = input ? input.value : null;
                    }
                });
                
                // Submit answers to server
                fetch('/submit_quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        quiz_id: quizQuestions[0].quiz_id,
                        answers: answers
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show results
                        quizModal.style.display = 'none';
                        
                        let resultMessage = `You scored ${data.score}%.\n`;
                        if (data.passed) {
                            resultMessage += 'Congratulations! You passed the quiz.';
                        } else {
                            resultMessage += 'You did not pass. Consider reviewing the material and trying again.';
                        }
                        
                        alert(resultMessage);
                        
                        // Refresh page to update progress
                        window.location.reload();
                    } else {
                        alert('Failed to submit quiz: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error submitting quiz: ' + error);
                });
            });
        }
            
            // View toggle functionality
            const viewButtons = document.querySelectorAll('.view-btn');
            const coursesGrid = document.querySelector('.courses-grid');
            
            viewButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    viewButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const viewType = this.getAttribute('data-view');
                    if (viewType === 'list') {
                        coursesGrid.classList.add('list-view');
                    } else {
                        coursesGrid.classList.remove('list-view');
                    }
                });
            });
            
        // Set progress bar widths based on data attributes
        document.querySelectorAll('.progress-bar[data-progress]').forEach(function(progressBar) {
            const progress = progressBar.getAttribute('data-progress');
            progressBar.style.width = progress + '%';
        });

        // Handle module start learning buttons
        const moduleStartBtns = document.querySelectorAll('.btn-start-module');
        moduleStartBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const moduleId = this.dataset.moduleId;
                const courseId = this.dataset.courseId;
                window.location.href = `/learning-interface/${courseId}/${moduleId}`;
                });
            });
        });
    </script>
</body>
</html> 