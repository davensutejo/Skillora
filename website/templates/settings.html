{% extends "base.html" %}

{% block title %}Settings | Skillora{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .settings-section {
            background-color: var(--surface-color, #fff);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-color-dark, #333);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--primary-color, #4f46e5);
        }
        
        .settings-form .form-group {
            margin-bottom: 20px;
        }
        
        .settings-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .settings-form input, 
        .settings-form select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color, #e2e8f0);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        
        .settings-form input:focus, 
        .settings-form select:focus {
            border-color: var(--primary-color, #4f46e5);
            outline: none;
        }
        
        .settings-form .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn-save {
            padding: 12px 25px;
            background-color: var(--primary-color, #4f46e5);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-save:hover {
            background-color: var(--primary-color-dark, #3730a3);
        }
        
        .btn-danger {
            padding: 12px 25px;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        
        .toggle-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .toggle-wrapper label {
            margin: 0;
            flex: 1;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color, #e2e8f0);
            transition: .4s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color, #4f46e5);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .danger-zone {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 20px;
        }
        
        .danger-zone-title {
            color: #b91c1c;
            font-weight: 600;
            margin-bottom: 15px;
        }
    </style>
{% endblock %}

{% block content %}
<body class="dashboard-page">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <a href="{{ url_for('views.dashboard') }}" class="sidebar-logo">
                <div class="logo-circle">
                    <div class="logo-letter">S</div>
                </div>
                <span class="logo-text">Skillora</span>
            </a>
            
            <div class="sidebar-menu">
                <p class="menu-category">Main</p>
                <a href="{{ url_for('views.dashboard') }}" class="menu-item">
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>
                <a href="{{ url_for('views.learning_path') }}" class="menu-item">
                    <i class="fas fa-graduation-cap"></i>
                    Learning Path
                </a>
                <a href="{{ url_for('views.my_courses') }}" class="menu-item">
                    <i class="fas fa-book"></i>
                    My Courses
                </a>
                
                <p class="menu-category">Resources</p>
                <a href="{{ url_for('views.tutors') }}" class="menu-item">
                    <i class="fas fa-chalkboard-teacher"></i>
                    AI Tutor
                </a>
                <a href="{{ url_for('views.dashboard') }}" class="menu-item">
                    <i class="fas fa-chart-line"></i>
                    Progress
                </a>
                
                <p class="menu-category">Account</p>
                <a href="{{ url_for('views.profile') }}" class="menu-item">
                    <i class="fas fa-user-circle"></i>
                    Profile
                </a>
                <a href="{{ url_for('views.settings') }}" class="menu-item active">
                    <i class="fas fa-cog"></i>
                    Settings
                </a>
            </div>
            
            <div class="user-profile">
                <div class="user-avatar">
                    {{ current_user.first_name[0] }}
                </div>
                <div class="user-info">
                    <div class="user-name">{{ current_user.first_name }}</div>
                    <div class="user-email">{{ current_user.email }}</div>
                </div>
                <a href="{{ url_for('auth.logout') }}" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
                </div>
            {% endif %}
            {% endwith %}
            
            <!-- Page Header -->
            <div class="dashboard-header">
                <div class="welcome-text">
                    <h1>Settings</h1>
                    <p>Configure your account settings and preferences</p>
                </div>
            </div>
            
            <!-- Settings Content -->
            <div class="settings-container">
                <!-- Account Settings -->
                <div class="settings-section">
                    <h2 class="section-title">
                        <i class="fas fa-user-shield"></i>
                        Account Settings
                    </h2>
                    
                    <form class="settings-form" method="POST" action="{{ url_for('views.update_account_settings') }}">
                        <div class="form-group">
                            <label for="current_password">Current Password</label>
                            <input type="password" id="current_password" name="current_password" required>
                        </div>
                        <div class="form-group">
                            <label for="new_password">New Password</label>
                            <input type="password" id="new_password" name="new_password">
                        </div>
                        <div class="form-group">
                            <label for="confirm_password">Confirm New Password</label>
                            <input type="password" id="confirm_password" name="confirm_password">
                        </div>
                        
                        <div class="button-group">
                            <button type="submit" class="btn-save">Update Password</button>
                        </div>
                    </form>
                </div>
                
                <!-- Notification Settings -->
                <div class="settings-section">
                    <h2 class="section-title">
                        <i class="fas fa-bell"></i>
                        Notification Settings
                    </h2>
                    
                    <form class="settings-form" method="POST" action="{{ url_for('views.update_notification_settings') }}">
                        <div class="toggle-wrapper">
                            <label for="email_course_updates">Email me about course updates</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="email_course_updates" name="email_course_updates" {% if notification_settings.email_course_updates %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-wrapper">
                            <label for="email_new_courses">Email me about new courses</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="email_new_courses" name="email_new_courses" {% if notification_settings.email_new_courses %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-wrapper">
                            <label for="email_achievement">Email me when I earn an achievement</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="email_achievement" name="email_achievement" {% if notification_settings.email_achievement %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-wrapper">
                            <label for="email_reminders">Email me course reminders</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="email_reminders" name="email_reminders" {% if notification_settings.email_reminders %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="button-group">
                            <button type="submit" class="btn-save">Save Notification Settings</button>
                        </div>
                    </form>
                </div>
                
                <!-- Privacy Settings -->
                <div class="settings-section">
                    <h2 class="section-title">
                        <i class="fas fa-lock"></i>
                        Privacy Settings
                    </h2>
                    
                    <form class="settings-form" method="POST" action="{{ url_for('views.update_privacy_settings') }}">
                        <div class="toggle-wrapper">
                            <label for="show_progress_public">Show my progress on leaderboards</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="show_progress_public" name="show_progress_public" {% if privacy_settings.show_progress_public %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-wrapper">
                            <label for="show_achievements_public">Show my achievements publicly</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="show_achievements_public" name="show_achievements_public" {% if privacy_settings.show_achievements_public %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-wrapper">
                            <label for="enable_study_analytics">Enable learning analytics collection</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="enable_study_analytics" name="enable_study_analytics" {% if privacy_settings.enable_study_analytics %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="button-group">
                            <button type="submit" class="btn-save">Save Privacy Settings</button>
                        </div>
                    </form>
                </div>
                
                <!-- Danger Zone -->
                <div class="settings-section">
                    <h2 class="section-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Danger Zone
                    </h2>
                    
                    <div class="danger-zone">
                        <h3 class="danger-zone-title">Delete Your Account</h3>
                        <p>Once you delete your account, there is no going back. Please be certain.</p>
                        
                        <button type="button" class="btn-danger" id="delete-account-btn">Delete Account</button>
                    </div>
                    
                    <!-- Delete Account Modal -->
                    <div class="modal" id="delete-account-modal" style="display: none;">
                        <div class="modal-content">
                            <h3>Are you sure you want to delete your account?</h3>
                            <p>This action cannot be undone. All your data will be permanently removed.</p>
                            
                            <form method="POST" action="{{ url_for('views.delete_account') }}">
                                <div class="form-group">
                                    <label for="delete_confirmation">Type "DELETE" to confirm</label>
                                    <input type="text" id="delete_confirmation" name="delete_confirmation" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="password_confirmation">Enter your password</label>
                                    <input type="password" id="password_confirmation" name="password_confirmation" required>
                                </div>
                                
                                <div class="button-group">
                                    <button type="button" class="btn-cancel" id="cancel-delete-btn">Cancel</button>
                                    <button type="submit" class="btn-danger" id="confirm-delete-btn">Delete My Account</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Settings page animations initialized");
        
        // Add initial animation states via CSS to prevent flash of unstyled content
        const styleElement = document.createElement('style');
        styleElement.textContent = `
            .dashboard-container { opacity: 0; }
            .main-content { opacity: 0; transform: translateY(20px); }
            .dashboard-header { opacity: 0; transform: translateY(-20px); }
            .settings-container { opacity: 0; transform: translateY(30px); }
            .settings-section { opacity: 0; transform: translateY(20px); }
            .section-title { opacity: 0; }
            .sidebar { opacity: 0; transform: translateX(-30px); }
            .user-profile { opacity: 0; }
            .settings-form .form-group, .toggle-wrapper, .danger-zone, .button-group { 
                opacity: 0; 
                transform: translateY(20px);
            }
        `;
        document.head.appendChild(styleElement);
        
        // Master timeline for coordinated animations
        setTimeout(() => {
            // 1. Animate sidebar first
            document.querySelector('.sidebar').style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
            document.querySelector('.sidebar').style.opacity = '1';
            document.querySelector('.sidebar').style.transform = 'translateX(0)';
            
            // 2. Then main container
            setTimeout(() => {
                document.querySelector('.dashboard-container').style.transition = 'opacity 0.5s ease-out';
                document.querySelector('.dashboard-container').style.opacity = '1';
                
                // 3. Then header
                setTimeout(() => {
                    document.querySelector('.dashboard-header').style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                    document.querySelector('.dashboard-header').style.opacity = '1';
                    document.querySelector('.dashboard-header').style.transform = 'translateY(0)';
                    
                    // 4. Settings container
                    setTimeout(() => {
                        document.querySelector('.settings-container').style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
                        document.querySelector('.settings-container').style.opacity = '1';
                        document.querySelector('.settings-container').style.transform = 'translateY(0)';
                        
                        // Animate all section titles
                        document.querySelectorAll('.section-title').forEach((title, index) => {
                            setTimeout(() => {
                                title.style.transition = 'opacity 0.4s ease-out';
                                title.style.opacity = '1';
                            }, 400 + (index * 100));
                        });
                        
                        // 5. Animate all settings sections with a staggered effect
                        document.querySelectorAll('.settings-section').forEach((section, index) => {
                            setTimeout(() => {
                                section.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                                section.style.opacity = '1';
                                section.style.transform = 'translateY(0)';
                            }, 500 + (index * 200));
                        });
                    }, 300);
                }, 150);
            }, 100);
            
            // Animate user profile in sidebar
            setTimeout(() => {
                document.querySelector('.user-profile').style.transition = 'opacity 0.5s ease-out';
                document.querySelector('.user-profile').style.opacity = '1';
            }, 700);
            
            // Main content area animation
            setTimeout(() => {
                document.querySelector('.main-content').style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
                document.querySelector('.main-content').style.opacity = '1';
                document.querySelector('.main-content').style.transform = 'translateY(0)';
            }, 300);
        }, 100);
        
        // Animate form groups with a staggered effect
        const formGroups = document.querySelectorAll('.settings-form .form-group');
        formGroups.forEach((group, index) => {
            setTimeout(() => {
                group.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                group.style.opacity = '1';
                group.style.transform = 'translateY(0)';
            }, 1000 + (index * 100));
        });
        
        // Animate toggle switches with a staggered effect
        const toggleWrappers = document.querySelectorAll('.toggle-wrapper');
        toggleWrappers.forEach((wrapper, index) => {
            setTimeout(() => {
                wrapper.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                wrapper.style.opacity = '1';
                wrapper.style.transform = 'translateY(0)';
            }, 1200 + (index * 80));
        });
        
        // Animate danger zone with a special attention-grabbing effect
        setTimeout(() => {
            const dangerZone = document.querySelector('.danger-zone');
            if (dangerZone) {
                dangerZone.style.transition = 'opacity 0.7s ease-out, transform 0.7s ease-out';
                dangerZone.style.opacity = '1';
                dangerZone.style.transform = 'translateY(0)';
            }
        }, 1800);
        
        // Animate button groups with a fade-in effect
        const buttonGroups = document.querySelectorAll('.button-group');
        buttonGroups.forEach((group, index) => {
            setTimeout(() => {
                group.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                group.style.opacity = '1';
                group.style.transform = 'translateY(0)';
            }, 1500 + (index * 100));
        });
        
        // Mobile sidebar toggle
        const sidebar = document.querySelector('.sidebar');
        const menuToggle = document.querySelector('.mobile-menu-toggle');
        
        if (menuToggle) {
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                
                // Toggle between hamburger and close icon
                const icon = this.querySelector('i');
                if (sidebar.classList.contains('active')) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                } else {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
                
                document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
            });
        }
        
        // Delete account modal with animations
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const deleteAccountModal = document.getElementById('delete-account-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteConfirmation = document.getElementById('delete_confirmation');
        
        if (deleteAccountBtn && cancelDeleteBtn) {
            deleteAccountBtn.addEventListener('click', function() {
                deleteAccountModal.style.display = 'flex';
                deleteAccountModal.style.opacity = '0';
                
                // Trigger reflow
                void deleteAccountModal.offsetWidth;
                
                deleteAccountModal.style.transition = 'opacity 0.4s ease-out';
                deleteAccountModal.style.opacity = '1';
                
                // Animate modal content
                const modalContent = deleteAccountModal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.transform = 'translateY(20px)';
                    modalContent.style.opacity = '0';
                    
                    setTimeout(() => {
                        modalContent.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out';
                        modalContent.style.transform = 'translateY(0)';
                        modalContent.style.opacity = '1';
                    }, 100);
                }
            });
            
            cancelDeleteBtn.addEventListener('click', function() {
                const modalContent = deleteAccountModal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                    modalContent.style.transform = 'translateY(20px)';
                    modalContent.style.opacity = '0';
                }
                
                setTimeout(() => {
                    deleteAccountModal.style.transition = 'opacity 0.3s ease-out';
                    deleteAccountModal.style.opacity = '0';
                    
                    setTimeout(() => {
                        deleteAccountModal.style.display = 'none';
                        deleteConfirmation.value = '';
                        document.getElementById('password_confirmation').value = '';
                    }, 300);
                }, 100);
            });
            
            // Enable/disable delete button based on confirmation text
            if (deleteConfirmation && confirmDeleteBtn) {
                deleteConfirmation.addEventListener('input', function() {
                    confirmDeleteBtn.disabled = (this.value !== 'DELETE');
                });
                
                // Initial state
                confirmDeleteBtn.disabled = true;
            }
        }
        
        // Form validation for password change with animated feedback
        const passwordForm = document.querySelector('form[action*="update_account_settings"]');
        if (passwordForm) {
            passwordForm.addEventListener('submit', function(e) {
                const newPassword = document.getElementById('new_password').value;
                const confirmPassword = document.getElementById('confirm_password').value;
                
                if (newPassword && newPassword !== confirmPassword) {
                    e.preventDefault();
                    
                    // Animated error feedback
                    const confirmField = document.getElementById('confirm_password');
                    confirmField.style.transition = 'all 0.3s ease';
                    confirmField.style.borderColor = '#ef4444';
                    confirmField.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
                    
                    // Shake animation
                    confirmField.style.transform = 'translateX(10px)';
                    setTimeout(() => {
                        confirmField.style.transform = 'translateX(-10px)';
                        setTimeout(() => {
                            confirmField.style.transform = 'translateX(5px)';
                            setTimeout(() => {
                                confirmField.style.transform = 'translateX(0)';
                            }, 100);
                        }, 100);
                    }, 100);
                    
                    // Reset after delay
                    setTimeout(() => {
                        confirmField.style.borderColor = '';
                        confirmField.style.backgroundColor = '';
                    }, 2000);
                    
                    alert('New passwords do not match. Please try again.');
                }
            });
        }
        
        console.log("Settings page animations completed");
    });
</script>
{% endblock %}
